<!DOCTYPE HTML>
<html lang="en">
    <head>
        <title>DAO Information</title>
        <meta charset="utf-8">
        <script src="web3.min.js"></script>
        <style>body{font:15px/1.4 Helvetica,arial,freesans,clean,sans-serif}h1{font-size:2.5em;border-bottom:1px solid rgb(221, 221, 221)}h2{font-size:2em;border-bottom:1px solid rgb(238, 238, 238)}code{background-color:rgb(248, 248, 248);border:1px solid rgb(221, 221, 221);font-size:13px;padding:0 5px;border-radius:3px}pre{background-color:rgb(248, 248, 248);border:1px solid rgb(221, 221, 221);padding:6px 10px;overflow:auto}pre code{border:none;padding:0}img{max-width:100%}blockquote{background:#f9f9f9;border-left:5px solid #cccccc;margin:1em 10px;padding:0.25em 10px}table{border-collapse:collapse;border-spacing:0;word-break:keep-all}table tr{background-color:#FFF;border-top:1px solid #CCC}table th{padding:6px 13px;border:1px solid #DDD;background-color:#cccccc}table td{padding:6px 13px;border:1px solid #DDD}table tr:nth-child(2n){background-color:#f8f8f8}td.wrap{word-break:break-all}.mono{word-break:break-all;font-size:small;font-family:monospace;white-space:nowrap}.monoreg{word-break:break-all;font-size:smaller;font-family:monospace;white-space:nowrap}body{margin-top:75px}.topnav{overflow:hidden;background-color:#e9e9e9}.topnav a{float:left;display:block;color:black;text-align:center;padding:10px 16px;text-decoration:none;font-size:17px;border-radius:10px;font-size:revert}div.topnav{margin-top:60px}table.topnav{width:100%;position:fixed;top:0;left:0;right:0;overflow:hidden;height:53px}tr.topnav td h1{border-bottom:0}tr.topnav,tr.topnav td{padding-top:0;padding-bottom:0;border:none}.topnav h1{margin-top:0;margin-bottom:0}.topnav a:hover{background-color:#ddd;color:black}.topnav a.active{padding:0 10px}.topnav a.active2{background-color:lightgrey;margin:2px;padding-top:1px;padding-bottom:1px}.topnav a.active3{background-color:lightgrey;margin-left:2px;margin-right:2px;padding-top:13px;padding-bottom:13px}h1.title{margin-top:4px;margin-bottom:-4px}.topnav input[type=text]{float:right;padding:6px;border:none;margin-top:8px;margin-right:16px;font-size:17px}@media screen and (max-width: 600px){.topnav a,.topnav input[type=text]{float:none;display:block;text-align:left;width:100%;margin:0;padding:14px}.topnav input[type=text]{border:1px solid #ccc}}table.nav{width:100%}table.nav tr{border:none}table.nav td{border:none}form.link input[type="submit"]{background:none;border:none;color:blue;text-decoration:underline;cursor:pointer;padding:0}.copylink{height:13px;width:13px;display:inline-block;margin-right:5px;vertical-align:middle;background-repeat:no-repeat;cursor:pointer}.navarrow{font-size:x-large;vertical-align:middle}table.transparent tr,table.transparent tr td{border:none;background-color:white}table.list{overflow:auto;height:100px}table.list thead th{position:sticky;z-index:1;top:53px}table.center td,table.list td{text-align:center}@keyframes fadeout{from{background-color:lightgrey}to{background-color:white}}span.price{padding:7px 7px 2px;background-color:white;border-radius:3px}.fadeout{animation:2s fadeout}img.cclogo{max-width:32px;max-height:32px;border:1px solid black;border-radius:18px}table.dlist tr td{background-color:white}.wide{display:inline}.narrow{display:none;word-break:break-all}@media (max-width:1000px){.wide{display:none}.narrow{display:inline}div.topnavm{display:block}div.topnav,table.topnav{display:none}table.list thead th{top:49px}}td.break{word-break:break-all}input.search{margin-bottom:8px;width:200px}table.list,table.single{margin-bottom:20px}.mobile-container{padding-left:0;padding-right:0;margin:auto;background-color:#555;height:0;border-radius:10px;margin-left:10px;margin-right:10px}.topnavm{overflow:hidden;background-color:#333;position:relative;display:none;position:fixed;left:0;top:0;width:100%}.topnavm #myLinks{display:none}.topnavm a{color:white;padding:14px 16px;text-decoration:none;font-size:17px;display:block}.topnavm a.title{font-size:large;color:#333;padding-top:10px;padding-bottom:10px}.topnavm a.icon{background:black;display:block;position:absolute;right:0;top:0;font-size:xx-large;padding-top:3px}.topnavm a:hover{background-color:#ddd;color:black}.activem{background-color:#e9e9e9;color:white}input.searchm{margin-bottom:8px;width:200px;font-size:large;margin-left:16px}div.topnavm{z-index:2}span.header_icon{height:20px;width:20px;display:inline-block;margin-right:5px;vertical-align:middle;background-repeat:no-repeat}span.title_icon{height:1em;width:1em;display:inline-block;margin-right:5px;background-repeat:no-repeat}a.header_link{background-color:lightgrey;margin:2px;padding:10px}.invert{filter: invert(100%)}code a{color:black;text-decoration:none}span.mono a{color:black;text-decoration:none}table.center tr td{text-align:center}</style>

    </head>
    <body style="margin-top:0">
        <h2>DAO Information</h2>
        <p>Purpose: <span id="purpose"></span></p>
        <p>How To Join: <span id="join_steps"></span></p>
        <p>Total proposals: <span id="total_proposals"></span></p> <!-- line 12 -->
        <p>NFTManager address: <span id='nftmanager'></span></p>
        <table id="dlist center"></table>
        <script>
// Javascript code here . loadTable adds rows to the table

var contractAddress = '0x8f8F78c6Bf8aFD02C948Bcf5DDCa61c40b94B1a5';     //change when redploy

let web3 = new Web3('wss://andromeda.cs.virginia.edu/geth');



abi = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"proposalID","type":"uint256"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":true,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"description","type":"string"}],"name":"NewProposal","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"proposalID","type":"uint256"},{"indexed":true,"internalType":"bool","name":"result","type":"bool"}],"name":"ProposalClosed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"proposalID","type":"uint256"},{"indexed":true,"internalType":"bool","name":"position","type":"bool"},{"indexed":true,"internalType":"address","name":"voter","type":"address"}],"name":"Voted","type":"event"},{"inputs":[{"internalType":"address","name":"who","type":"address"}],"name":"addMember","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"proposalID","type":"uint256"}],"name":"closeProposal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"curator","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"howToJoin","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"who","type":"address"}],"name":"isMember","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minProposalDebatePeriod","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"debatingPeriod","type":"uint256"}],"name":"newProposal","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"numberOfProposals","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"i","type":"uint256"}],"name":"proposals","outputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"bool","name":"","type":"bool"},{"internalType":"bool","name":"","type":"bool"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"purpose","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"requestMembership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"reservedEther","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tokens","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"proposalID","type":"uint256"},{"internalType":"bool","name":"supportsProposal","type":"bool"}],"name":"vote","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"},{"internalType":"uint256","name":"pid","type":"uint256"}],"name":"votedNo","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"},{"internalType":"uint256","name":"pid","type":"uint256"}],"name":"votedYes","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}]

contract = new web3.eth.Contract(abi,contractAddress);


//nftmanager abi
nftManagerAbi = [{'inputs': [{'internalType': 'address', 'name': 'to', 'type': 'address'}, {'internalType': 'uint256', 'name': 'tokenId', 'type': 'uint256'}], 'name': 'approve', 'outputs': [], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': '_to', 'type': 'address'}, {'internalType': 'string', 'name': '_uri', 'type': 'string'}], 'name': 'mintWithURI', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [{'internalType': 'string', 'name': '_uri', 'type': 'string'}], 'name': 'mintWithURI', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [{'internalType': 'uint256', 'name': 'tokenId', 'type': 'uint256'}], 'name': 'tokenURI', 'outputs': [{'internalType': 'string', 'name': '', 'type': 'string'}], 'stateMutability': 'view', 'type': 'function'}];


// get the NFT contract
var nftContract = null;
const getNFTManager = async() => {
	contract.methods.tokens().call().then( a => { nftContract = new web3.eth.Contract(nftManagerAbi,a);
															 loadTable();
															 document.getElementById("nftmanager").innerHTML = a ;
															} );
}

//nftContractAddr = getNFTManagerAddr();
//nftContract = new web3.eth.Contract(nftManagerAbi,nftContractAddr);
getNFTManager();

//functions to get info
// An async function to get the dao proposal info
const getProposalInfo = async(i) => {
	return await contract.methods.proposals(i).call();
}

//Get number of proposals
const getNumProposals = async() => {
	return await contract.methods.numberOfProposals().call();
}


//description
const getPurpose = async() => {
    //document.getElementById("purpose").innerHTML = await contract.methods.purpose().call();
	return await contract.methods.purpose().call();
}

//how to join
const getHowToJoin = async() => {
    //document.getElementById("join_steps").innerHTML = await contract.methods.howToJoin().call();
	return await contract.methods.howToJoin().call();
}


// An asnc function to write the chioce info, once received, to the HTML
// page.
const setProposalInfo = async(i) => {
	getProposalInfo(i).then(l => { document.getElementById("Recipient_"+i).innerHTML = l[0]; document.getElementById("Amount_"+i).innerHTML = l[1] / (10**18);
        document.getElementById("Description_"+i).innerHTML = l[2];
        var dateFormat= new Date(l[3] * 1000); //get unix timestamp

        document.getElementById("Deadline_"+i).innerHTML = (dateFormat.getMonth()+1)+"-"+dateFormat.getDate()+"-"+dateFormat.getFullYear()+", time: "+dateFormat.getHours()+":"+dateFormat.getMinutes();
        document.getElementById("open_"+i).innerHTML = l[4];

        document.getElementById("pass_"+i).innerHTML = l[5];
        document.getElementById("yes_"+i).innerHTML = l[6];
        document.getElementById("no_"+i).innerHTML = l[7];
        document.getElementById("creator_"+i).innerHTML = l[8]; });

    }

//document.getElementById("purpose").innerHTML = getPurpose();
//document.getElementById("join_steps").innerHTML = getHowToJoin();

function loadTable() {

    getNumProposals().then(val => {
            // set that value in the "Total number of Proposals:"
            document.getElementById("total_proposals").innerHTML = val;
            // create the table body to list the votes and choices
            text = "<tr><th>ID</th><th>Recipient</th><th>Amount (ETH)</th><th>Description</th><th>Voting deadline</th><th>Open?</th><th>Did it pass?</th><th>Yes votes</th><th>No votes</th><th>Creator</th></tr>";
            // for each of the choices, create a separate table row with unique IDs
            for ( var i = 0; i < val; i++ )
                text += "<tr><td id='id_" + i + "'>" + i + "</td><td id='Recipient_" + i + "'></td><td id='Amount_" + i + "'></td><td id='Description_" + i + "'></td><td id='Deadline_" + i + "'></td><td id='open_" + i + "'></td><td id='pass_" + i + "'></td><td id='yes_" + i + "'></td><td id='no_" + i + "'></td><td id='creator_" + i + "'></td></tr>";
            // write the table to the HTML page; this must happen BEFORE we start filling in the votes and choices
            document.getElementById("dlist center").innerHTML = text;
            // FILL IN THE TABLE WITH CORRECT STUFF
            for ( var i = 0; i < val; i++ )
                setProposalInfo(i);
        });
        getPurpose().then(val => {
		// update the purpose field
		document.getElementById("purpose").innerHTML = val;
	});
	getHowToJoin().then(val => {
		// update the purpose field
		document.getElementById("join_steps").innerHTML = val;
	});


}



//LISTEN TO EVENTS
function subscribeToDaoEvents() {
    var options = { address: contractAddress };
    var sub = web3.eth.subscribe('logs', options, function(err,event) {
        if ( !err )
            console.log("event error: "+event);
    });
    // pay attention to these subscription events:
    sub.on('data', event => loadTable() )
    sub.on('error', err => { throw err })
}

loadTable();

subscribeToDaoEvents();

        </script>
    </body>
</html>